# -----------------------------------------
# User Registry
# -----------------------------------------

type User @entity(immutable: false) {
  id: ID!                 # wallet address (hex)
  wallet: Bytes!
  role: Int!
  createdAt: BigInt!
  isBlocked: Boolean!
}

type UserRegistered @entity(immutable: true) {
  id: Bytes!
  wallet: Bytes!
  role: Int!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type UserBlocked @entity(immutable: true) {
  id: Bytes!
  wallet: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type UserUnblocked @entity(immutable: true) {
  id: Bytes!
  wallet: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# -----------------------------------------
# Enums
# -----------------------------------------

enum JobStatus {
  OPEN
  IN_PROGRESS
  SUBMITTED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
}

# -----------------------------------------
# Core State Entities
# -----------------------------------------

type Job @entity(immutable: false) {
  id: ID!                  # jobId (bytes32 hex)
  client: Bytes!
  freelancer: Bytes

  status: JobStatus!
  budget: BigInt!

  bidDeadline: BigInt!
  expireDeadline: BigInt!

  ipfsHash: String
  ipfsProof: String

  createdAt: BigInt!
  submittedAt: BigInt
  completedAt: BigInt

  fundLockedAt: BigInt
  fundReleasedAt: BigInt
  fundRefundedAt: BigInt

  fundLockedAmount: BigInt
  fundReleasedAmount: BigInt
  fundRefundedAmount: BigInt
}

type Bid @entity(immutable: false) {
  id: ID!                  # jobId-bidIndex
  job: Job!
  bidder: Bytes!
  status: BidStatus!
  amount: BigInt!
  createdAt: BigInt!
  ipfsProposal: String!
}

type JobCreated @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  client: Bytes!
  budget: BigInt!
  bidDeadline: BigInt!
  expireDeadline: BigInt!
  ipfs: String!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type JobDetailsUpdated @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  client: Bytes!
  budget: BigInt!
  bidDeadline: BigInt!
  expireDeadline: BigInt!
  ipfs: String!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type BidSubmitted @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  amount: BigInt!
  bidIndex: BigInt!
  proposalIpfs: String!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type BidAccepted @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  amount: BigInt!
  bidIndex: BigInt!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type BidRejected @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  amount: BigInt!
  bidIndex: BigInt!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type JobStarted @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type WorkSubmitted @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  ipfsProof: String!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type JobCompleted @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  freelancer: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type JobCancelled @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  client: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# -----------------------------------------
# Disputes
# -----------------------------------------

type DisputeRaised @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  by: Bytes!
  reasonIpfs: String!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type DisputeResolved @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  winner: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

# -----------------------------------------
# Funds
# -----------------------------------------

type FundLocked @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  amountLocked: BigInt!
  bidAmount: BigInt!
  client: Bytes!
  freelancer: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type FundReleased @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  amountToFreelancer: BigInt!
  feeToTreasury: BigInt!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}

type FundRefunded @entity(immutable: true) {
  id: Bytes!
  jobId: Bytes!
  amountRefunded: BigInt!
  client: Bytes!
  blockNumber: BigInt!
  blockTimestamp: BigInt!
  transactionHash: Bytes!
}
